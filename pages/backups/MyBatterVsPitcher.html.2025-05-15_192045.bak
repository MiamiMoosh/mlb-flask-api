<!-- In this version:
Manage My Players works
Show Only My Players Button works
Clear My Players Works
Table loads
Favorites works
Search works

-->

<!DOCTYPE html>
<html lang="en">
<head>
    <title>MLB Stats Tracker</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css">
    <style>
        body { font-family: Arial, sans-serif; text-align: center; font-size: 12px; }
        .nav-container { display: flex; justify-content: center; align-items: center; margin: 10px 0; }
        .nav-link { text-decoration: none; font-size: 16px; font-weight: bold; padding: 6px; color: #007bff; transition: all 0.3s ease-in-out; }
        .nav-link:hover { text-decoration: underline; font-weight: bold; color: #0056b3; }
        .current-date { font-size: 18px; font-weight: bold; margin: 0 15px; }
        table { width: 90%; border-collapse: collapse; margin: 10px auto; opacity: 0; animation: fadeIn 1s forwards; }
        th, td { text-align: center; padding: 6px; border: 1px solid #ddd; font-size: 11px; }
        .star { cursor: pointer; font-size: 16px; padding-left: 5px; transition: all 0.2s ease-in-out; color: gray; }
        .star.selected { color: gold; }
        .star:hover { text-shadow: 0px 0px 5px gold; }
        .favorite-container { margin-top: 15px; font-size: 14px; font-weight: bold; }
        .remove-btn { font-size: 14px; cursor: pointer; color: red; margin-right: 4px; }
        .header-container { display: flex; justify-content: center; align-items: center; position: relative; }
        .clear-btn { position: absolute; right: 20%; padding: 6px 12px; border: 1px solid #ccc; background-color: #f8f9fa; color: #333; border-radius: 5px; cursor: pointer; transition: 0.3s; }
        .clear-btn:hover { background-color: #e2e6ea; }
		#togglePlayersBtn { display: block; margin: 10px auto 20px; padding: 6px 12px; border: none; background-color: #007bff; color: white; border-radius: 5px; cursor: pointer; transition: 0.3s; }
        #togglePlayersBtn:hover { background-color: #0056b3; }
        #player-list span { display: inline-block; margin-right: 10px; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="header-container">
        <h2>Manage My Players</h2>
        <button class="clear-btn" onclick="clearFavorites()">Clear My Players</button>
    </div>
    <div id="player-list"></div>

    <div class="nav-container">
        <a id="prev-day" class="nav-link" href="#">««««« <span id="prev-date"></span></a>
        <span class="current-date" id="date-display"></span>
        <a id="next-day" class="nav-link" href="#"><span id="next-date"></span> »»»»»</a>
    </div>
    
    <button id="togglePlayersBtn" onclick="toggleFavorites()">Show Only My Players</button>

    <div id="stats-container">
        <strong class='loading-message'>⏳ Loading Data...</strong>
    </div>

    <script>
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                let date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + JSON.stringify(value) + expires + "; path=/";
        }

        function getCookie(name) {
            let cookies = document.cookie.split("; ");
            for (let cookie of cookies) {
                let [key, value] = cookie.split("=");
                if (key === name) return JSON.parse(value || "[]");
            }
            return [];
        }

        let favoritePlayers = getCookie("favoritePlayers");
        let showingFavorites = false;

        function loadStats() {
            $("#stats-container").html("<strong class='loading-message'>⏳ Loading Data...</strong>");

            $.getJSON("/stats", function(data) {
                $("#stats-container").empty();

                if (!data || data.length === 0) {
                    $("#stats-container").html("<div class='error-message'>⚠ No data available for this date.</div>");
                    return;
                }

                let tableHTML = `
                    <table id="stats-table">
                        <thead>
                            <tr>
                                <th>Team Batter</th><th>Batter</th>
                                <th>Team Pitcher</th><th>Pitcher</th>
                                <th>PA</th><th>AB</th><th>H</th><th>1B</th><th>2B</th><th>3B</th><th>HR</th>
                                <th>BB</th><th>SO</th><th>AVG</th><th>OBP</th><th>SLG</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                `;
                $("#stats-container").html(tableHTML);

                let table = $("#stats-table").DataTable({
                    "paging": false, 
                    "scrollY": "600px", 
                    "ordering": true, 
                    "info": false 
                });

                data.forEach(row => {
                    if (showingFavorites && !favoritePlayers.includes(row.batter) && !favoritePlayers.includes(row.pitcher)) {
                        return;
                    }

                    let batterStar = `<span class='star ${favoritePlayers.includes(row.batter) ? "selected" : ""}' data-player="${row.batter}" onclick='toggleFavorite("${row.batter}")'>✩</span>`;
                    let pitcherStar = `<span class='star ${favoritePlayers.includes(row.pitcher) ? "selected" : ""}' data-player="${row.pitcher}" onclick='toggleFavorite("${row.pitcher}")'>✩</span>`;

                    table.row.add([
                        row.team_batter, `${batterStar} ${row.batter}`,
                        row.team_pitcher, `${pitcherStar} ${row.pitcher}`,
                        row.stats.PA, row.stats.AB, row.stats.H,
                        row.stats['1B'], row.stats['2B'], row.stats['3B'], row.stats.HR,
                        row.stats.BB, row.stats.SO, row.stats.AVG, row.stats.OBP, row.stats.SLG
                    ]);
                });

                table.draw();
                updateFavoriteList();
            });
        }

        function toggleFavorite(player) {
            if (favoritePlayers.includes(player)) {
                favoritePlayers = favoritePlayers.filter(p => p !== player);
            } else {
                favoritePlayers.push(player);
            }
            setCookie("favoritePlayers", favoritePlayers, 180);
            document.querySelectorAll(`.star[data-player="${player}"]`).forEach(el => el.classList.toggle("selected"));
            updateFavoriteList();
        }

        function updateFavoriteList() {
            let listContainer = $("#player-list").empty();
            favoritePlayers.forEach(player => {
                listContainer.append(`<span class="remove-btn" onclick="toggleFavorite('${player}')">❌</span><span> ${player}</span>`);
            });
        }
		
        function toggleFavorites() {
            showingFavorites = !showingFavorites;
            $("#togglePlayersBtn").text(showingFavorites ? "Show All Players" : "Show My Players");
            $("#stats-table").DataTable().rows().every(function() {
                let row = this.node();
                let playerName = $(row).find(".star").data("player");
                $(row).toggle(showingFavorites ? favoritePlayers.includes(playerName) : true);
            });
        }
		
		function clearFavorites() {
            favoritePlayers = [];
            setCookie("favoritePlayers", favoritePlayers, 180);
            updateFavoriteList();
            $(".star").removeClass("selected");
        }
		
        $(document).ready(() => {
            loadStats();
            updateFavoriteList();
        });
    </script>
</body>
</html>