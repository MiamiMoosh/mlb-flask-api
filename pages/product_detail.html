{% extends "_base.html" %}

{% block meta %}
  {% if product %}
    <title>{{ product.title }} ‚Äì First String</title>
    <meta name="description" content="{{ product.seo_description or product.title }}">
    <meta property="og:title" content="{{ product.title }}">
    <meta property="og:description" content="{{ product.seo_description or product.title }}">
    <meta property="og:type" content="product">
    {% if product.images %}
      <meta property="og:image" content="{{ product.images[0].src }}">
    {% endif %}
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />

    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    {% endif %}
{% endblock %}

{% block content %}
<div class="wrapper">
  <div class="empty-container"></div>
  <div class="dashboard-panel">
    <h1 class="product-title">{{ product.title }}</h1>

    {% if product.seo_description %}
      <p class="product-description">{{ product.seo_description }}</p>
    {% endif %}

    <div id="main-image" style="text-align: center; margin-bottom: 1rem;">
      <img id="selected-image"
           src="{{ product.images[0].src if product.images and product.images[0].src }}"
           alt="{{ product.title }}"
           style="width: 100%; max-width: 400px; max-height: 400px; object-fit: contain; border-radius: 8px;" />
    </div>

    <div id="thumbnails" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 2rem;">
      {% for img in product.images %}
        <img src="{{ img.src }}"
             alt="Thumbnail"
             class="thumbnail"
             onclick="selectImage('{{ img.src }}', this)"
             style="width: 100%; height: 80px; object-fit: cover; border-radius: 4px; cursor: pointer; border: 2px solid transparent;" />
      {% endfor %}
    </div>

    <form id="variant-form" style="margin-bottom: 1rem;">
      {% for option in product.options %}
        {% set safe_id = "opt-" + option.name | lower | replace(' ', '-') %}
        <label for="{{ safe_id }}">{{ option.name }}</label>
        <select id="{{ safe_id }}" name="{{ option.name }}" data-option="{{ loop.index0 }}">
          {% for val in option["values"] %}
            {% set img_url = "/static/images/Tshirt Colors/" + val.name + ".png" %}
            <option value="{{ val.name }}"
                    data-custom-properties='{{ {"image": img_url} | tojson | escape }}'>
              {{ val.name }}
            </option>
          {% endfor %}
        </select>
      {% endfor %}
      <input type="hidden" id="selected-variant-id" name="variant_id">
    </form>

    <p id="price-display" class="price-display">$‚Äî</p>

    <label for="coupon-code">Have a coupon?</label>
    <input type="text" id="coupon-code" placeholder="Enter code"
           style="margin-bottom: 1rem; padding: 0.5rem; width: 100%;" />

    <button id="add-to-cart"
            data-printify-id="{{ product.printify_id }}"
            data-discount="{{ product.discount_percent | default(0) }}">
      üõí Add to Cart
    </button>

    {% if is_admin %}
      <div style="margin-top: 2rem;">
        <a href="/admin/edit-product/{{ product.slug }}"
           style="padding: 0.5rem 1rem; background: #eee; border-radius: 4px; text-decoration: none; border: 1px solid #ccc;">
          ‚úèÔ∏è Edit Product
        </a>
      </div>
    {% endif %}

    <ul style="list-style: none; margin-top: 2rem; padding: 0;">
      {% if product.collection %}<li><strong>Collection:</strong> {{ product.collection }}</li>{% endif %}
      {% if product.team %}<li><strong>Team:</strong> {{ product.team }}</li>{% endif %}
      {% if product.sport %}<li><strong>Sport:</strong> {{ product.sport }}</li>{% endif %}
      {% if product.city and product.state %}<li><strong>Location:</strong> {{ product.city }}, {{ product.state }}</li>{% endif %}
      {% if product.tags %}<li><strong>Tags:</strong> {{ product.tags | join(', ') }}</li>{% endif %}
    </ul>

    <section style="margin-top: 3rem;">
      <h2>Shipping & Returns</h2>
      <p>Orders ship within 2‚Äì4 business days. Most arrive within 5‚Äì9 days depending on your location.</p>
      <p>Returns accepted on unworn items within 30 days. <a href="/return-policy">Learn more</a>.</p>
    </section>
  </div>
</div>

<style>
  body {
    background: url("/static/images/firststring_bg.png") no-repeat center center fixed;
    background-size: cover;
    background-color: #000;
    font-family: 'Orbitron', sans-serif;
    color: white;
    margin: 0;
    overflow-x: hidden;
  }

  .product-title {font-family: 'Canes', sans-serif;font-size: 28px;margin-bottom: 1rem;}
  .product-description {font-size: 14px;margin-bottom: 1.5rem;color: #ccc;}
  .price-display {font-size: 16px;color: #C0C8B6;margin: 1rem 0;}
  .choices__inner {background-color: #111;border: 1px solid #666;border-radius: 4px;padding: 6px 8px;font-size: 14px;color: #fff;min-height: 38px;line-height: 1.2;}
  .choices__list--dropdown {background-color: #1D1F21;border: 1px solid #AA0000;max-height: 240px;overflow-y: auto;}
  .thumbnail.selected {border-color: #AA0000 !important;}
  button {background-color: #AA0000;color: white;border: none;border-radius: 4px;padding: 8px 16px;font-size: 14px;font-family: 'Orbitron', sans-serif;cursor: pointer;transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;}
  button:hover {background-color: #CC0000;box-shadow: 0 0 6px #AA0000;}
  button:disabled {background-color: #444;color: #999;cursor: default;box-shadow: none;}

</style>

<script>
  const product = {
    options: {{ product.options | tojson }},
    variants: {{ product.variants | tojson }}
  };


  function selectImage(src, el) {
  const img = document.getElementById("selected-image");
  if (!img || !src) return;
  img.style.opacity = 0;
  setTimeout(() => {
    img.src = src;
    img.onload = () => (img.style.opacity = 1);
  }, 150);

  document.querySelectorAll(".thumbnail").forEach(t => t.classList.remove("selected"));
  if (el) el.classList.add("selected");
}

document.addEventListener("DOMContentLoaded", () => {
  const first = document.querySelector(".thumbnail");
  if (first) {
    first.classList.add("selected");
    const preload = new Image();
    preload.src = document.getElementById("selected-image")?.src || "";
  }
});

const variantForm = document.getElementById("variant-form");
const addToCartBtn = document.getElementById("add-to-cart");
const couponField = document.getElementById("coupon-code");
const priceDisplay = document.getElementById("price-display");
const variants = product.variants || [];
const baseDiscount = parseFloat(addToCartBtn?.dataset.discount || 0);

function normalizeName(name) {
  return name.trim().toLowerCase().replace(/\s+/g, "-");
}

function normalize(str) {
  return str?.trim().toLowerCase().replace(/\s+/g, "-");
}

function findMatchingVariant() {
  const selects = variantForm?.querySelectorAll("select") || [];
  const selectedOptionIds = [];

  for (let s of selects) {
    const label = s.name;
    const optMeta = product.options.find(o => o.name === label);

    const selectedName = s.value;
    const valMatch = optMeta?.values?.find(v => v.name === selectedName);

    if (valMatch?.id == null) {
      console.warn(`‚ùå Couldn't find ID for "${label}" ‚Üí "${selectedName}"`);
      return null;
    }

    selectedOptionIds.push(valMatch.id);
  }

  const match = product.variants.find(v =>
    JSON.stringify(v.options) === JSON.stringify(selectedOptionIds)
  );

  if (!match) {
    console.warn("üö´ No matching variant for IDs:", selectedOptionIds);
  }

  document.getElementById("selected-variant-id").value = match?.id || "";
  updatePriceDisplay(match);

  if (match?.images?.length > 0) {
    selectImage(match.images[0].src);
  }

  return match;
}

function updatePriceDisplay(variant) {
  if (!variant || typeof variant.price !== "number") {
    priceDisplay.innerHTML = "Price unavailable";
    console.warn("‚ùå No price found on variant:", variant);
    return;
  }

  let discount = baseDiscount;
  const code = couponField?.value.trim().toLowerCase();
  if (code === "summer25") discount = 25;
  if (code === "freefan") discount = 100;

  const price = variant.price / 100;
  const sale = price * (1 - discount / 100);

  if (discount > 0 && discount < 100) {
    priceDisplay.innerHTML = `$<s>${price.toFixed(2)}</s> ‚Üí $${sale.toFixed(2)} (${discount}% off)`;
  } else if (discount >= 100) {
    priceDisplay.innerHTML = `<strong>üéâ Free with code!</strong>`;
  } else {
    priceDisplay.innerHTML = `$${price.toFixed(2)}`;
  }
  console.log("üí° variant in updatePriceDisplay:", variant);
}

variantForm?.addEventListener("change", findMatchingVariant);
couponField?.addEventListener("input", () => updatePriceDisplay(findMatchingVariant()));
findMatchingVariant();

addToCartBtn?.addEventListener("click", () => {
  const variantId = document.getElementById("selected-variant-id").value;
  const productId = addToCartBtn.dataset.printifyId;
  if (!variantId) return alert("Please select a variant.");

  const cart = JSON.parse(localStorage.getItem("firststring_cart") || "[]");
  cart.push({ printify_id: productId, variant_id: variantId, qty: 1 });
  localStorage.setItem("firststring_cart", JSON.stringify(cart));
  alert("Added to cart!");
});

document.addEventListener("DOMContentLoaded", function () {
  const el = document.getElementById("opt-colors");
  if (!el) {
    console.warn("‚ùå #opt-colors not found");
    return;
  }

  new Choices(el, {
    allowHTML: true,
    itemSelectText: '',
    callbackOnCreateTemplates: function (template) {
      return {
        choice: (classNames, data) => {
          let image = data.customProperties?.image || '';

          return template(`
            <div class="${classNames.item} choices__item--selectable" data-id="${data.id}" data-value="${data.value}" role="option">
              <img src="${image}" alt="" style="width:20px; height:20px; object-fit:cover; border-radius:3px; margin-right:8px; vertical-align:middle;" />
              ${data.label}
            </div>
          `);
        }
      };
    }
  });
});
</script>

{% endblock %}