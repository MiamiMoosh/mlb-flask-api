{% extends "_base.html" %}

{% block meta %}
  {% if product %}
    <title>{{ product.title }} ‚Äì First String</title>
    <meta name="description" content="{{ product.seo_description or product.title }}">
    <meta property="og:title" content="{{ product.title }}">
    <meta property="og:description" content="{{ product.seo_description or product.title }}">
    <meta property="og:type" content="product">
    {% if product.images %}
      <meta property="og:image" content="{{ product.images[0].src }}">
    {% endif %}
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  {% endif %}
{% endblock %}

{% block head %}
  <style>
    body { background: url("/static/images/firststring_bg.png") no-repeat center center fixed; background-size: cover; background-color: #000; font-family: 'Orbitron', sans-serif; color: white; margin: 0; overflow-x: hidden; }
@font-face { font-family: 'Canes'; src: url('{{ url_for('static', filename='fonts/Canes.otf') }}') format('opentype'); font-weight: normal; font-style: normal; font-display: swap; }
@font-face { font-family: 'Orbitron'; src: url('{{ url_for('static', filename='fonts/Orbitron-Regular.ttf') }}') format('truetype'); font-weight: normal; font-style: normal; font-display: swap; }
@font-face { font-family: 'Orbitron'; src: url('{{ url_for('static', filename='fonts/Orbitron-Bold.ttf') }}') format('truetype'); font-weight: bold; font-style: normal; font-display: swap; }
.header-wrapper { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 80px; background-image: url("/static/images/firststring_bg.png"); background-repeat: no-repeat; background-size: cover; background-position: center; background-attachment: fixed; z-index: 9999; }
.header-left, .header-right { width: 100%; display: flex; align-items: flex-start; }
.header-left { justify-content: flex-end; padding-right: 50px; }
.header-left img { max-width: 80%; width: 300px; object-fit: contain; }
.main-menu { font-family: 'Canes', sans-serif; background: #1D1F21; }
.main-menu ul { list-style: none; margin: 0; padding: 0; display: flex; font-size: 16px; }
.main-menu ul li { position: relative; padding: 5px 10px; }
.main-menu ul li a { color: #fff; text-decoration: none; font-size: 16px; }
.dropdown-content, .submenu-content { display: none !important; position: absolute; background: #1D1F21; border: 1px solid #AA0000; min-width: 200px; z-index: 1000; }
.dropdown:hover > .dropdown-content, .submenu:hover > .submenu-content { display: block !important; }
.wrapper { margin-top: 80px; display: flex; width: 100vw; position: relative; }
.empty-container { flex: 1; }
.dashboard-panel { flex: 1; padding: 20px; }
.product-title { font-family: 'Orbitron', sans-serif; font-weight: bold; font-size: 18px; background-color: rgba(20, 20, 20, 0.8); padding: 8px 12px; border-radius: 4px; color: white; margin-bottom: 1rem; }
.product-description { font-size: 13px; color: #ccc; background-color: rgba(30, 30, 30, 0.75); padding: 10px; border-radius: 4px; line-height: 1.5; max-width: 600px; margin-top: 2rem; }
.price-display { font-size: 20px; font-weight: bold; color: #C0C8B6; margin: 1rem 0; }
.thumbnail.selected { border-color: #AA0000 !important; }
.choices__inner { background-color: #111 !important; border: 1px solid #666; border-radius: 4px; padding: 4px 6px; font-size: 13px; color: white; max-width: 280px; height: 36px !important; }
.choices[data-type*=select-one] .choices__inner { padding-bottom: 0; }
.choices__list--dropdown, .choices__list[aria-expanded] { background-color: #000 !important; border: 1px solid #AA0000; color: white; font-size: 13px; }
.choices__list--dropdown .choices__item { color: white; padding: 8px 12px; }
.choices__list--dropdown .choices__item--selectable:hover { background-color: #1D1F21; }
.product-section { display: flex; gap: 24px; align-items: flex-start; flex-wrap: wrap; }
.thumbnail-panel { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: repeat(5, 1fr); gap: 8px; max-height: 400px; }
.thumbnail-panel img { width: 80px; height: 80px; object-fit: cover; border-radius: 4px; border: 2px solid transparent; cursor: pointer; }
.main-image-container { width: 400px; height: 400px; display: flex; align-items: center; justify-content: center; }
#selected-image { width: 100%; height: 100%; object-fit: contain; border-radius: 8px; }
.variant-options-row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-bottom: 1rem; }
.price-and-cart { display: flex; align-items: center; justify-content: space-between; gap: 24px; margin-bottom: 2rem; }
button { background-color: #AA0000; color: white; border: none; border-radius: 4px; padding: 8px 16px; font-size: 14px; font-family: 'Orbitron', sans-serif; cursor: pointer; transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
button:hover { background-color: #CC0000; box-shadow: 0 0 6px #AA0000; }
button:disabled { background-color: #444; color: #999; cursor: default; box-shadow: none; }
  </style>

<div class="wrapper">
  <div class="empty-container"></div>
  <div class="dashboard-panel">
    <h1 class="product-title">{{ product.title }}</h1>

    <div class="product-section">
      <div class="thumbnail-panel">
        {% for img in product.images %}
          <img src="{{ img.src }}" class="thumbnail" alt="Thumbnail" onclick="selectImage('{{ img.src }}', this)">
        {% endfor %}
      </div>
      <div class="main-image-container">
        <img id="selected-image"
             src="{{ product.images[0].src if product.images and product.images[0].src }}"
             alt="{{ product.title }}">
      </div>
    </div>

    <form id="variant-form">
      <div class="variant-options-row">
        {% for option in product.options %}
          {% set safe_id = "opt-" + option.name | lower | replace(' ', '-') %}
          <select id="{{ safe_id }}" name="{{ option.name }}" data-option="{{ loop.index0 }}">
            {% for val in option["values"] %}
              {% set img_url = "/static/images/Tshirt Colors/" + val.name + ".png" %}
              <option value="{{ val.name }}" data-custom-properties='{{ {"image": img_url} | tojson | escape }}'>
                {{ val.name }}
              </option>
            {% endfor %}
          </select>
        {% endfor %}
        <input type="hidden" id="selected-variant-id" name="variant_id">
      </div>
    </form>

    <div class="price-and-cart">
      <p id="price-display" class="price-display">$‚Äî</p>
      <button id="add-to-cart"
              data-printify-id="{{ product.printify_id }}"
              data-discount="{{ product.discount_percent | default(0) }}">
        üõí Add to Cart
      </button>
    </div>

    {% if product.seo_description %}
      <p class="product-description">{{ product.seo_description }}</p>
    {% endif %}

    {% if is_admin %}
      <div style="margin-top: 2rem;">
        <a href="/admin/edit-product/{{ product.slug }}"
           style="padding: 0.5rem 1rem; background: #eee; border-radius: 4px; text-decoration: none; border: 1px solid #ccc;">
          ‚úèÔ∏è Edit Product
        </a>
      </div>
    {% endif %}

    <ul style="list-style: none; margin-top: 2rem; padding: 0;">
      {% if product.collection %}<li><strong>Collection:</strong> {{ product.collection }}</li>{% endif %}
      {% if product.team %}<li><strong>Team:</strong> {{ product.team }}</li>{% endif %}
      {% if product.sport %}<li><strong>Sport:</strong> {{ product.sport }}</li>{% endif %}
      {% if product.city and product.state %}<li><strong>Location:</strong> {{ product.city }}, {{ product.state }}</li>{% endif %}
      {% if product.tags %}<li><strong>Tags:</strong> {{ product.tags | join(', ') }}</li>{% endif %}
    </ul>

    <section style="margin-top: 3rem;">
      <h2>Shipping & Returns</h2>
      <p>Orders ship within 2‚Äì4 business days. Most arrive within 5‚Äì9 days depending on your location.</p>
      <p>Returns accepted on unworn items within 30 days. <a href="/return-policy">Learn more</a>.</p>
    </section>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const product = {
    options: {{ product.options | tojson }},
    variants: {{ product.variants | tojson }}
  };

  function selectImage(src, el) {
    const img = document.getElementById("selected-image");
    if (!img || !src) return;
    img.style.opacity = 0;
    setTimeout(() => {
      img.src = src;
      img.onload = () => (img.style.opacity = 1);
    }, 150);
    document.querySelectorAll(".thumbnail").forEach(t => t.classList.remove("selected"));
    if (el) el.classList.add("selected");
  }

  function updatePriceDisplay(variant) {
    const priceDisplay = document.getElementById("price-display");
    const couponField = document.getElementById("coupon-code");
    const baseDiscount = parseFloat(document.getElementById("add-to-cart")?.dataset.discount || 0);

    if (!variant || typeof variant.price !== "number") {
      priceDisplay.innerHTML = "Price unavailable";
      return;
    }

    let discount = baseDiscount;
    const code = couponField?.value.trim().toLowerCase();
    if (code === "summer25") discount = 25;
    if (code === "freefan") discount = 100;

    const price = variant.price / 100;
    const sale = price * (1 - discount / 100);

    if (discount >= 100) {
      priceDisplay.innerHTML = `<strong>üéâ Free with code!</strong>`;
    } else if (discount > 0) {
      priceDisplay.innerHTML = `$<s>${price.toFixed(2)}</s> ‚Üí $${sale.toFixed(2)} (${discount}% off)`;
    } else {
      priceDisplay.innerHTML = `$${price.toFixed(2)}`;
    }
  }

  function findMatchingVariant() {
    const selects = document.querySelectorAll("#variant-form select");
    const selectedOptionIds = [];

    for (let s of selects) {
      const label = s.name;
      const optMeta = product.options.find(o => o.name === label);
      const selectedName = s.value;
      const valMatch = optMeta?.values?.find(v => v.name === selectedName);
      if (valMatch?.id == null) return null;
      selectedOptionIds.push(valMatch.id);
    }

    const match = product.variants.find(v =>
      JSON.stringify(v.options) === JSON.stringify(selectedOptionIds)
    );

    document.getElementById("selected-variant-id").value = match?.id || "";
    updatePriceDisplay(match);
    if (match?.images?.length > 0) {
      selectImage(match.images[0].src);
    }

    return match;
  }

  document.addEventListener("DOMContentLoaded", () => {
    const first = document.querySelector(".thumbnail");
    if (first) first.classList.add("selected");

    findMatchingVariant();

    document.getElementById("variant-form")?.addEventListener("change", findMatchingVariant);
    document.getElementById("coupon-code")?.addEventListener("input", () => {
      updatePriceDisplay(findMatchingVariant());
    });

    document.getElementById("add-to-cart")?.addEventListener("click", () => {
      const variantId = document.getElementById("selected-variant-id").value;
      const productId = document.getElementById("add-to-cart").dataset.printifyId;
      if (!variantId) return alert("Please select a variant.");

      const cart = JSON.parse(localStorage.getItem("firststring_cart") || "[]");
      cart.push({ printify_id: productId, variant_id: variantId, qty: 1 });
      localStorage.setItem("firststring_cart", JSON.stringify(cart));
      alert("Added to cart!");
    });

    const colorSelect = document.getElementById("opt-colors");
    if (colorSelect) {
      new Choices(colorSelect, {
        allowHTML: true,
        itemSelectText: '',
        callbackOnCreateTemplates: function (template) {
          return {
            choice: (classNames, data) => {
              let image = data.customProperties?.image || '';
              return template(`
                <div class="${classNames.item} choices__item--selectable" data-id="${data.id}" data-value="${data.value}" role="option">
                  <img src="${image}" alt="" style="width:20px; height:20px; object-fit:cover; border-radius:3px; margin-right:8px; vertical-align:middle;" />
                  ${data.label}
                </div>
              `);
            }
          };
        }
      });
    }
  });
</script>
{% endblock %}